---
published: false
---
# Создание RSS-ленты из ВК групп
Я большой любитель [RSS](https://ru.wikipedia.org/wiki/RSS). Я хочу читать 
группы и паблики ВК прямо в RSS-клиенте, но ВК не поддерживает такой функционал
из коробки. Значит нужно делать самому. Есть ряд готовых решений, но они как-то
не работают, да и вообще, я программист, свой велосипед ближе.

## Технологии
Я давно хотел изучить какой-нибудь лисп (мне очень нравится синтаксис), выбрал
[Clojure](https://ru.wikipedia.org/wiki/Clojure), потому что он мощен. Он
работает на виртуальной машине Java, значит, я могу использовать очень много
разных библиотек. С остальным разберусь по ходу дела.

## Зачем нужна эта статья?
Каждая статья должна быть написана. Поэтому я её пишу.

# Процесс
## Создание
Я назвал проект `vk2rss`, из названия сразу понятно, что проект умеет делать.
Создаю проект и создаю git-репозиторий:

```bash
lein new vk2rss
cd vk2rss
git init
```

`lein` — программа, которая управляет проектами на Clojure и умеет много чего,
мне даже разбираться в этом страшно. В папке `vk2rss` теперь много файлов:

```bash
$ tree
.
├── CHANGELOG.md
├── doc
│   └── intro.md
├── LICENSE
├── project.clj
├── README.md
├── resources
├── src
│   └── vk2rss
│       └── core.clj
└── test
    └── vk2rss
        └── core_test.clj
```

Всё из этого нужно для великих целей. В файле `project.clj` задают информацию
о проекте, зависимостях, плагинах для `lein`, лицензии, авторах и всём таком.
Вот так он выглядит по умолчанию:

```clojure
(defproject vk2rss "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.8.0"]])
```

В глаза бросается интересный синтаксис. Мне он нравится, но для некоторых он
травмоопасен. Поскольку я проект пока не публикую, со всем разберусь попозже.
Пока нужно установить зависимости. Очевидно, мне нужна библиотека для RSS и 
API ВКонтакте.

Для RSS есть библиотека [`clj-rss`](https://github.com/yogthos/clj-rss). С API
ВКонтакте поинтереснее. Есть официальный SDK для Java, а Clojure умеет
вызывать код на Java. Но этот SDK всё же заточен под Java, везде обьекты и 
какие-то сложности, а я натура тонкая, могу не выдержать. Поэтому гуглю `vk api
clojure` и хватаю первую библиотеку. Ею оказалась билиотека [`clojure-vk`](
https://github.com/acedened/clojure-vk). Она очень давно не поддерживается
автором, да и автор, видно, не очень заморачивался инструкцией по установке и
всем таким. Ничего, разберёмся.

Чтобы установить зависимости в проект, изменяю `:dependencies` в `project.clj`
вот так:

```clojure
:dependencies [[org.clojure/clojure "1.8.0"]
               [clojure-vk "0.1.0-SNAPSHOT"]
               [clj-rss "0.2.3"]]
```

Мне нравится, что версия Clojure — тоже зависимость. При запуске `lein repl` 
все зависимости должны установиться, и откроется REPL — туда можно писать
выражения, они тут же скомпилируются и будут выполнены. Крутые кложуристы
сначала играются в REPL'e, лишь затем приступают к писанию файлов. Так я и
сделаю.

# Разработка
Эта секция подразумевает, что анонимный читатель знает те вещи, которые я не
обьясняю. Если нет, то надо догадаться о чём я говорю либо узнать самим. Если я
где-то накосячил, то надо мне об этом сказать.

## Доступ к API
Сначала нужно создать приложение на сайте ВК. В официальной [документации](
https://vk.com/dev/first_guide) во втором пункте (Application registration)
написано как сделать приложение. Мне очень не понравилось это делать, но
главное в итоге получить App ID. В третьем пункте описано, как вручную получить
токен, чтобы иметь доступ к API, но библиотека нам в этом поможет, поэтому
читать необязательно.

Запускаем `lein repl` и пишем туда команды:

```clojure
user=> (use 'clojure-vk.core 'clojure-vk.auth) ; подключаем библиотеку
nil
user=> (def app-id ******) ; вместо звёздочек написать свой App ID
#'user/app-id
user=> (def auth-url   ; получаем ссылку, по которой надо перейти, чтобы
  #_=>   (get-auth-url ; получить свой токен
  #_=>     app-id
  #_=>     "https://oauth.vk.com/blank.html"
  #_=>     :display-page
  #_=>     {:score (scope :offline)
  #_=>      :response-type "token"}))
#'user/auth-url
user=> (println auth-url) ; смотрим, какая же эта ссылка
<тут ссылка, у каждого она своя>
nil
```

Полученную ссылку вставляем в адресную строку браузера, нас перенаправляет куда
надо, копируем адрес. Копируем `access_token` из адреса. Это длинная 
последовательность разных символов. Я сохраню его в переменную:

```clojure
user=> (def vk-token "<токен тут>")
#'user/vk-token
```

Теперь у меня есть доступ к API! Запросы к API делают функцией `clojure-vk/vk`.
Она принимаем три аргумента: `[category method params]`. Для начала, нужно
посмотреть [список всех методов API](https://vk.com/dev/methods). В названии
каждого есть точка. То, что до точки — категория, то, что после — метод. Прямо
как в ООП. Каждый метод принимает параметры, их список есть на странице
описания метода. Названия категорий и методов нужно передавать не строкой, а 
ключевым словом. Писать можно не в camelCase, а в kebab-case:

```clojure
user=> (vk :users :get {:user-ids "durov"
  #_=>                  :access-token vk-token})
[{:id 1, :first-name "Pavel", :last-name "Durov"}]
```

## _Архитектура
`vk2rss` будет всего-лишь очередной библиотекой, которую затем можно будет
элегантно использовать. В файле `src/vk2rss/core.clj` будет основной код.
Открываю и вижу это:

```clojure
(ns vk2rss.core)

(defn foo
  "I don't do a whole lot."
  [x]
  (println x "Hello, World!"))
```

`defn` создаёт функции. Мне очень нравится, что документация — просто аргумент,
это открывает большие возможности, а ещё такую документацию приятно писать.
В макрос `ns` добавляю зависимости:

```clojure
(ns vk2rss.core
  (:require 'clojure-vk.core :as vk-api)
  (:require 'clj-rss.core :as rss)
  (:require 'clojure.java.io :as io))
```

`clojure.java.io` нужен для работы с файлами.

---

### Получение информации о группе
Метод [`groups.getById`](https://vk.com/dev/groups.getById) — то, что нужно.
Тестовый запрос:

```clojure
user=> (pprint (vk :groups :get-by-id 
  #_=>   {:group-id 95648824 :access-token vk-token :fields "description"}))
[{:description "первые, единственные и настоящие",
  :photo-100
  "https://pp.userapi.com/c846322/v846322120/43af9/Hbxj0AME-8w.jpg?ava=1",
  :name "мемы про котов (по ржать)",
  :type "page",
  :is-closed 0,
  :screen-name "memy_pro_kotow",
  :id 95648824,
  :photo-200
  "https://pp.userapi.com/c846322/v846322120/43af8/i9zsXGPRIfw.jpg?ava=1",
  :photo-50
  "https://pp.userapi.com/c846322/v846322120/43afa/HVRX6ycNw3o.jpg?ava=1"}]
nil
```
